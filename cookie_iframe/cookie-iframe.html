<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Global Cookie Iframe page</title>
		<script>
			var adcm_config = {
				id:1114,
				platformId: 114
			}
			
			function loadJS(src, callback) {
				var s = document.createElement('script');
				s.src = src;
				s.async = true;
				s.onreadystatechange = s.onload = function () {
					var state = s.readyState;
					if (!callback.done && (!state || /loaded|complete/.test(state))) {
						callback.done = true;
						callback();
					}
				};
				document.getElementsByTagName('head')[0].appendChild(s);
			}
		</script>	
		<!--<script src="https://tag.digitaltarget.ru/adcm.js" async></script>-->
		<!--adcm script-->
		<!--tag.digitaltarget.ru-->
		<script>
			window.adcm={session:Math.round(1e15*Math.random()),config:{script:window.location.protocol+"//cdn.probtn.com/cookie_iframe/processor.js?i="+Math.round(1e15*Math.random()),profileData:"",id:null,tags:[],extdataid:!1,triggers:{noBounce:{enable:!1,timeout:15,param_call:{},callback:function(){}},init_call:{enable:!0,param_call:{},callback:function(){}},elapsed_seconds:{enable:!1,timeouts:[5,10,30,60,120,300],param_call:{},callback:function(){}},page_down_scroll:{enable:!1,margin_bottom:100,param_call:{},callback:function(){}},scroll_to:{enable:!1,param_call:{},markers:[],window_checkpoint_percent:50,callback:function(){}},config:{enable:!1,el_id:"",el_class_name:"",callback:function(){}},push_to_server:{success:function(){},error:function(){}}}},params:{tags:[]},loaded:!1,configure:function(a,b){var c=this,d=this.config.id;"function"==typeof a.init&&(b=a.init,delete a.init);for(var e in a)if(a.hasOwnProperty(e))if("triggers"===e){for(var f in a[e])if(a[e].hasOwnProperty(f))for(var g in a[e][f])if(a[e][f].hasOwnProperty(g)){if(!c.config.triggers.hasOwnProperty(f))continue;c.config.triggers[f][g]=a[e][f][g]}}else this.config[e]=a[e];return this.session&&this.config.script&&this.config.id?(this.loaded?d!==this.config.id?c.relocate(function(){b&&"function"==typeof b&&b()}):b&&"function"==typeof b&&b():this.load(function(){c.relocate(function(){if(b&&"function"==typeof b&&(c.config.triggers.init_call.enable=!1),c.triggers){c.config.triggers.config.enable===!0&&(c.triggers.config(),c.config.triggers.config.enable=!1);for(var a in c.triggers)c.config.triggers[a].enable===!0&&c.triggers[a]()}b&&"function"==typeof b&&b()})}),this):void(console&&console.log&&console.log("Wrong adcm configuration..."))},ext:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},ready:function(a,b){function c(){if(!f){f=!0;for(var a=0;a<e.length;a++)e[a].fn.call(window,e[a].ctx);e=[]}}function d(){"complete"===document.readyState&&c()}var e=[],f=!1,g=!1;return f?void setTimeout(function(){a(b)},1):(e.push({fn:a,ctx:b}),void("complete"===document.readyState||!document.attachEvent&&"interactive"===document.readyState?setTimeout(c,1):g||(document.addEventListener?(document.addEventListener("DOMContentLoaded",c,!1),window.addEventListener("load",c,!1)):(document.attachEvent("onreadystatechange",d),window.attachEvent("onload",c)),g=!0)))},load:function(a,b){var c=this;(!this.loaded||b)&&this.ready(function(){var d=document.createElement("script");d.src=b||c.config.script,d.onload=function(){c.loaded=!0,a&&a()},document.getElementsByTagName("head")[0].appendChild(d)})}},window.adcm_config&&window.adcm.configure(window.adcm_config);
		</script>
    </head>
    <body>		
		<script>			
            String.prototype.ProBtnHashCode = function () {
                var hash = 0;
                //, i, char;
                var char1 = 0;
                var i = 0;
                if (this.length === 0) return hash;
                for (i = 0, l = this.length; i < l; i++) {
                    char1 = this.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char1;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash;
            };

            var cookieFunctions = {
                GetDeviceCUID: function () {
                    var probtnId = "1234";
					var readCookieValue = cookieFunctions.readCookie("probtnCID");
                    if ((readCookieValue !== null) && (readCookieValue !== undefined) && (readCookieValue !== "null") && (readCookieValue !== "") && (readCookieValue !== "undefined")) {
						probtnId = readCookieValue;
                    } else {
                        //set cookie
                        var currentdate = new Date();
                        currentdate = currentdate.getTime();
                        probtnId = currentdate.toString() + "-" + navigator.userAgent.toString().ProBtnHashCode();
                        cookieFunctions.createCookie("probtnCID", probtnId, 365);
                    }  
					
                    return probtnId;
                },
                createCookie: function (name, value, days) {
                    var expires = "";
                    if (days) {
                        var date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        expires = "; expires=" + date.toGMTString();
                    }
                    document.cookie = name + "=" + value + expires + "; path=/";
                },
                readCookie: function (name) {
                    var nameEQ = name + "=";
                    var ca = document.cookie.split(';');
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                },
                eraseCookie: function (name) {
                    cookieFunctions.createCookie(name, "", -1);
                }
            }
	
			window.onload = function() {
				var cookieName = cookieFunctions.GetDeviceCUID(); //cookieFunctions.readCookie("probtnCID");
				if (cookieName == null) {
					cookieName = cookieFunctions.GetDeviceCUID();
				}         

				if (window.self !== window.top) {
					
					var deviceCUID_item = {'type': 'probtnCID', 'cid': cookieName};
					console.log("deviceCUID_item", deviceCUID_item);
					window.top.postMessage(deviceCUID_item, "*");
					
					//make global matching with amber data
					//loadJS('https://tag.digitaltarget.ru/adcm.js', function () {
						try {
							if (typeof window.adcm.call === "function") {
								console.log("init adcm", {profileId: cookieName});
								window.adcm.call({profileId: cookieName});
							} else {
								console.log("init adcm is not a function", {profileId: cookieName});
							}
						} catch(ex) {
							console.log("probtn adcm call", ex);
						}
					//});			
					
					try {
						var elem = document.createElement('script');
						elem.src = '//x01.aidata.io/pixel.js?pixel=PROBTN&id='+cookieName+'&v=' + Date.now();
						elem.type='text/javascript';
						elem.async = true;
						var s = document.getElementsByTagName('script')[0];
						s.parentNode.insertBefore(elem, s);
					} catch(ex) {
						console.log("aidata exception",ex);
					}
				}
				
				var receiveMessage = function (event) {
					if ((event.data.command !== undefined) && (event.data.command !== null) && (event.data.command === "amber_matching")) {
						try {
							//console.log("init adcm", {profileId: cookieName});
							//window.adcm.call({profileId: cookieName});
						  } catch(ex) {
							console.log(ex);
						  }
					}
				}
				window.self.addEventListener("message", receiveMessage, false);
			}
        </script>
    </body>
</html>
